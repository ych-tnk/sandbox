name: Dispatch release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: Select a release type
        required: true
        type: choice
        options:
          - 'ga'
          - 'rc'

jobs:
  resolve_release_version:
    runs-on: ubuntu-latest
    outputs:
      value: ${{ steps.resolve_release_version.outputs.value }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest release tag name
        id: get_latest_release_tag_name
        run: |
          case "${{ github.event.inputs.release_type }}" in
            'ga')
              echo "value=$(gh api /repos/{owner}/{repo}/releases --jq 'first(.[] | select(.prerelease != true) | select(.draft != true)).tag_name')" >> $GITHUB_OUTPUT
              ;;
            'rc')
              echo "value=$(gh api /repos/{owner}/{repo}/releases --jq 'first(.[] | select(.draft != true)).tag_name')" >> $GITHUB_OUTPUT
              ;;
          esac
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check existence of releasable differences
        id: check_existence_releaseable_differences
        run: |
          diff="$(git diff --shortstat ${{ steps.get_latest_release_tag_name.outputs.value }}...)"
          if [ -n "${diff}" ]; then
            echo "has_diffrences=true" >> $GITHUB_OUTPUT
          else
            case "${{ github.event.inputs.release_type }}" in
              'ga')
                echo "::warning::The GA release publication is skipped because there is no difference between the latest GA release and HEAD."
                ;;
              'rc')
                echo "::warning::The RC release publication is skipped because there is no difference between the latest release and HEAD."
                ;;
            esac
            echo "has_diffrences=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update draft release
        if: steps.check_existence_releaseable_differences.outputs.has_diffrences == 'true'
        id: create_or_update_draft_release
        uses: release-drafter/release-drafter@master
        with:
          config-name: release-drafter.yaml
          prerelease: ${{ github.event.inputs.release_type != 'ga' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve release version
        id: resolve_release_version
        run: |
          if [ -n "${{ steps.create_or_update_draft_release.outputs.tag_name }}" ]; then
            echo "value=${{ steps.create_or_update_draft_release.outputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ steps.get_latest_release_tag_name.outputs.value }}" >> $GITHUB_OUTPUT
          fi

  publish_gem:
    needs: resolve_release_version
    uses: ./.github/workflows/_publish_gem.yaml
    permissions:
      contents: write
      pull-requests: write
      packages: write
    with:
      version: ${{ needs.resolve_release_version.outputs.value }}
      gemspec_path: sandbox.gemspec
    secrets:
      pr_create_token: ${{ secrets.TEST }}

  publish_draft_release:
    needs: 
      - resolve_release_version
      - publish_gem
    uses: ./.github/workflows/_publish_draft_release.yaml
    permissions:
      contents: write
      pull-requests: write
    with:
      prerelease: ${{ github.event.inputs.release_type != 'ga' }}
      version: ${{ needs.resolve_release_version.outputs.value }}
